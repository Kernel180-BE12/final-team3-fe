# 템플릿 승인 버튼 비활성화 개선 계획

## 개요
템플릿 생성 응답이 HTTP 200 상태코드가 아닌 경우 '이 템플릿 승인하기' 버튼을 비활성화하여 사용자 경험을 개선하고 오류 상황을 명확히 표시합니다.

## 현재 상황 분석

### 현재 코드 구조 (GeneratorPageV3.jsx)
```javascript
// 승인 상태 관리
const [approvedTemplates, setApprovedTemplates] = useState(new Set());
const [approvingTemplates, setApprovingTemplates] = useState(new Set());

// 템플릿 생성 핸들러에서 응답 처리
const handleGenerate = async (prompt) => {
  // HTTP 상태 코드가 200이 아닌 경우 에러 처리 (line 254-266)
  if (response && response.status && response.status !== 200) {
    const errorMessage = response.error?.message ||
      `서버 오류가 발생했습니다. (상태코드: ${response.status})`;

    const botErrorMessage = {
      id: Date.now() + 1,
      type: "error",
      text: errorMessage,
    };
    setMessages((prev) => [...prev, botErrorMessage]);
    return;
  }
}

// 승인 버튼 상태 확인 (line 194-199)
const isApproving = selectedVersion?.templateId
  ? approvingTemplates.has(selectedVersion.templateId)
  : false;
const isApproved = selectedVersion?.templateId
  ? approvedTemplates.has(selectedVersion.templateId)
  : false;
```

### 문제점
1. **에러 상태 추적 부재**: HTTP 200이 아닌 응답을 받은 템플릿에 대한 상태 추적이 없음
2. **승인 버튼 로직 불완전**: 에러가 발생한 템플릿도 승인 가능한 상태로 남아있음
3. **사용자 혼란**: 실패한 템플릿 생성에 대해서도 승인 버튼이 활성화되어 혼란 야기

## 개선 방안

### 1. 에러 상태 관리 추가
```javascript
// 새로운 state 추가
const [errorTemplates, setErrorTemplates] = useState(new Set());
```

### 2. 템플릿 생성 응답 처리 개선
```javascript
const handleGenerate = async (prompt) => {
  setIsLoading(true);
  const userMessage = { id: Date.now(), type: "user", text: prompt };
  setMessages((prev) => [...prev, userMessage]);

  try {
    const response = await templateApi.generateTemplate(prompt);

    // HTTP 상태 코드가 200이 아닌 경우
    if (response && response.status && response.status !== 200) {
      const errorTemplateId = `ERROR_TPL_${Date.now()}`;

      // 에러 템플릿 ID를 에러 상태에 추가
      setErrorTemplates((prev) => new Set(prev).add(errorTemplateId));

      const errorMessage = response.error?.message ||
        `서버 오류가 발생했습니다. (상태코드: ${response.status})`;

      const botErrorMessage = {
        id: Date.now() + 1,
        type: "error",
        text: errorMessage,
        templateId: errorTemplateId // 에러 템플릿 ID 추가
      };

      setMessages((prev) => [...prev, botErrorMessage]);
      return;
    }

    // 성공적인 응답 처리
    if (response && response.data) {
      const templateData = response.data;
      const newVersionData = {
        templateId: templateData.id || `TPL_${Date.now()}`,
        // ... 기존 로직
      };

      // 성공한 템플릿은 에러 상태에서 제거 (혹시 있다면)
      setErrorTemplates((prev) => {
        const newSet = new Set(prev);
        newSet.delete(newVersionData.templateId);
        return newSet;
      });

      // ... 기존 성공 처리 로직
    }
  } catch (error) {
    // 네트워크 에러 등 예외 상황
    const errorTemplateId = `NETWORK_ERROR_${Date.now()}`;
    setErrorTemplates((prev) => new Set(prev).add(errorTemplateId));

    const errorMessage = {
      id: Date.now() + 1,
      type: "error",
      text: "템플릿 생성 중 오류가 발생했습니다. 네트워크 연결을 확인하고 다시 시도해주세요.",
      templateId: errorTemplateId
    };
    setMessages((prev) => [...prev, errorMessage]);
  } finally {
    setIsLoading(false);
  }
};
```

### 3. 승인 버튼 상태 로직 개선
```javascript
// 승인 상태 확인 함수들 수정
const isApproving = selectedVersion?.templateId
  ? approvingTemplates.has(selectedVersion.templateId)
  : false;

const isApproved = selectedVersion?.templateId
  ? approvedTemplates.has(selectedVersion.templateId)
  : false;

// 에러 상태 확인 함수 추가
const hasError = selectedVersion?.templateId
  ? errorTemplates.has(selectedVersion.templateId)
  : false;

// 승인 버튼 비활성화 조건
const isApprovalDisabled = !selectedVersion?.templateId || hasError || isApproving || isApproved;
```

### 4. UI 컴포넌트 전달 props 수정
```javascript
<ThreePanelLayout
  // ... 기존 props
  onApproveTemplate={handleApproveTemplate}
  isApproving={isApproving}
  isApproved={isApproved}
  hasError={hasError} // 새로운 prop 추가
  isApprovalDisabled={isApprovalDisabled} // 새로운 prop 추가
/>
```

## 구현 단계

### Phase 1: 상태 관리 개선
1. `errorTemplates` state 추가
2. `handleGenerate` 함수에서 에러 상태 추적 로직 구현
3. 에러 템플릿 ID 할당 및 관리

### Phase 2: 승인 로직 개선
1. `hasError` 상태 확인 함수 구현
2. `isApprovalDisabled` 조건 로직 구현
3. 승인 버튼 비활성화 조건 통합

### Phase 3: UI 개선
1. ThreePanelLayout 컴포넌트에 새로운 props 전달
2. 에러 상태일 때 버튼 비활성화 및 시각적 피드백
3. 에러 메시지와 버튼 상태 연동

### Phase 4: 테스트 및 검증
1. 다양한 HTTP 상태 코드에 대한 테스트
2. 네트워크 에러 상황 테스트
3. 승인 버튼 상태 변화 검증

## 예상 효과

### 사용자 경험 개선
- **명확한 상태 표시**: 에러가 발생한 템플릿에 대해 승인 불가능함을 명확히 표시
- **혼란 방지**: 실패한 템플릿 생성에 대한 잘못된 승인 시도 방지
- **일관성**: 템플릿 상태와 UI 동작의 논리적 일관성 확보

### 시스템 안정성
- **데이터 무결성**: 에러가 발생한 템플릿의 승인 방지
- **API 호출 최적화**: 불필요한 승인 API 호출 방지
- **에러 추적**: 템플릿 생성 실패 패턴 분석 가능

## 위험 요소 및 고려사항

### 기술적 위험
1. **상태 관리 복잡성 증가**: errorTemplates state 추가로 인한 복잡성
2. **메모리 사용량**: 에러 템플릿 ID 누적으로 인한 메모리 사용량 증가
3. **컴포넌트 리렌더링**: 추가 state로 인한 성능 영향

### 해결 방안
1. **메모리 관리**: 세션 종료 시 errorTemplates 정리
2. **성능 최적화**: useMemo, useCallback 활용한 리렌더링 최적화
3. **단순화**: 복잡한 로직을 작은 함수들로 분리

## 구현 우선순위
1. **High**: 에러 상태 추적 및 승인 버튼 비활성화 (핵심 기능)
2. **Medium**: UI 피드백 개선 (사용자 경험)
3. **Low**: 에러 패턴 분석 및 로깅 (향후 개선)

## 결론
템플릿 생성 실패 시 승인 버튼을 비활성화하는 것은 사용자 경험과 시스템 안정성 모두에 중요한 개선사항입니다. 단계적 구현을 통해 안전하게 기능을 추가할 수 있습니다.